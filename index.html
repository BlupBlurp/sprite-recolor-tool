<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta
      name="description"
      content="Create custom shiny PokÃ©mon sprites with advanced color clustering and recoloring algorithms. Professional tool for BDSP modding and PokÃ©mon sprite editing."
    />
    <meta property="og:title" content="PokÃ©mon Shiny Recolor Tool" />
    <meta
      property="og:description"
      content="Create custom shiny PokÃ©mon sprites with advanced color clustering and recoloring algorithms."
    />
    <meta property="og:type" content="website" />
    <title>PokÃ©mon Shiny Recolor Tool - Create Custom Shiny Sprites</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <fieldset>
          <legend>PokÃ©mon</legend>
          <div class="kv kv-onecol">
            <div class="row" style="gap: 4px">
              <select
                id="folderSel"
                style="flex: 1"
                title="Select a PokÃ©mon folder to work with"
              >
                <option value="">(pick root)</option>
              </select>
              <button
                id="prevPokemon"
                class="btn gray small"
                title="Previous PokÃ©mon"
              >
                â€¹
              </button>
              <button
                id="nextPokemon"
                class="btn gray small"
                title="Next PokÃ©mon"
              >
                â€º
              </button>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Textures</legend>
          <div class="kv kv-onecol">
            <div id="texList" style="max-height: 200px; overflow-y: auto">
              <small>Select a folder to list textures</small>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Settings</legend>
          <div class="settings-controls">
            <div class="settings-item">
              <div class="settings-header">
                <label>Family Count</label>
                <span id="kVal">32</span>
              </div>
              <input
                id="k"
                type="range"
                min="5"
                max="48"
                value="32"
                title="Number of color families to group similar colors together. Higher values create more distinct color areas."
              />
            </div>
            <div class="settings-item">
              <div class="settings-header">
                <label>Protect Outline</label>
                <span id="inkVal">8</span>
              </div>
              <input
                id="ink"
                type="range"
                min="0"
                max="50"
                value="8"
                title="Protects dark pixels (like outlines) from being recolored. Higher values protect more pixels."
              />
            </div>
            <div class="settings-item">
              <div class="settings-header">
                <label>Smoothing</label>
                <span id="smoothPxVal">1</span>
              </div>
              <input
                id="smoothPx"
                type="range"
                min="0"
                max="5"
                value="1"
                title="Applies smoothing to reduce noise and artifacts. Higher values create smoother transitions."
              />
            </div>
            <div class="settings-item">
              <div class="settings-header">
                <label>Blending</label>
                <span id="smoothAmtVal">45%</span>
              </div>
              <input
                id="smoothAmt"
                type="range"
                min="0"
                max="100"
                value="45"
                title="Controls how much smoothing is applied. Higher values create more blended colors."
              />
            </div>
            <div class="settings-item">
              <div class="settings-header">
                <label>Contrast</label>
                <span id="contrastVal">110%</span>
              </div>
              <input
                id="contrast"
                type="range"
                min="50"
                max="170"
                value="110"
                title="Adjusts the contrast of the final shiny sprite. Higher values increase contrast."
              />
            </div>
            <!-- Hidden legacy sliders -->
            <div style="display: none">
              <label class="mut">Spatial weight</label>
              <input id="spw" type="range" min="0" max="200" value="60" />
              <span id="spwVal">0.60</span>
            </div>
          </div>

          <!-- Settings action buttons -->
          <div
            style="
              display: flex;
              gap: 6px;
              justify-content: center;
              margin-top: 8px;
            "
          >
            <button
              id="recluster"
              class="btn gray small"
              title="Recalculates color families with current settings. Use after changing Family Count or other clustering parameters."
            >
              Recluster
            </button>
            <button
              id="restoreDefaults"
              class="btn gray small"
              title="Restores all settings to their default values."
            >
              Restore Defaults
            </button>
          </div>
        </fieldset>
        <fieldset>
          <legend
            id="experimentalToggle"
            style="cursor: pointer; user-select: none"
          >
            <span id="experimentalArrow">â–¶</span> Experimental
          </legend>
          <div
            id="experimentalContent"
            class="experimental-controls"
            style="display: none"
          >
            <div class="experimental-item">
              <div class="experimental-header">
                <label>Color Consensus</label>
                <span id="colorConsensusVal">1</span>
              </div>
              <input
                id="colorConsensus"
                type="range"
                min="1"
                max="10"
                value="1"
                title="Number of texture candidates to consider for color suggestions. Higher values blend more textures for smoother results."
              />
            </div>
            <div class="experimental-item">
              <div class="experimental-header">
                <label>Spatial Weight</label>
                <span id="spatialWeightVal">0%</span>
              </div>
              <input
                id="spatialWeight"
                type="range"
                min="0"
                max="100"
                value="0"
                title="Weight position similarity when matching colors. 0% = color only (current behavior), higher values consider spatial position."
              />
            </div>
            <div class="experimental-item">
              <div class="experimental-header">
                <label>Color Tolerance</label>
                <span id="colorToleranceVal">0%</span>
              </div>
              <input
                id="colorTolerance"
                type="range"
                min="0"
                max="100"
                value="0"
                title="Allows matching distant colors with fallback strategies. 0% = strict matching (current behavior), higher values enable adaptive thresholds."
              />
            </div>
          </div>
        </fieldset>
        <fieldset>
          <legend id="debugToggle" style="cursor: pointer; user-select: none">
            <span id="debugArrow">â–¶</span> Debug
          </legend>
          <div
            id="debugContent"
            class="experimental-controls"
            style="display: none"
          >
            <div class="row">
              <label class="toggle"
                ><input
                  id="showDebug"
                  type="checkbox"
                  title="Shows an overlay highlighting protected pixels that won't be recolored."
                />
                Show protected overlay</label
              >
              <label class="toggle"
                ><input
                  id="showRegionOutline"
                  type="checkbox"
                  title="Shows an outline around the currently selected color family."
                />
                Show selected family outline</label
              >
              <label class="toggle"
                ><input
                  id="showAllFamilies"
                  type="checkbox"
                  title="Shows outlines around all color families in the sprite."
                />
                Show all families outline</label
              >
              <label class="toggle"
                ><input
                  id="multiSeedPreview"
                  type="checkbox"
                  title="Shows 4 different seed variations in a 2x2 grid. Click on any variant to select it and exit preview mode."
                />
                Multi-seed Preview</label
              >
              <div class="row" style="gap: 4px; margin-top: 8px">
                <label style="font-size: 12px; color: #888">Seed:</label>
                <span
                  id="currentSeed"
                  style="
                    font-family: monospace;
                    font-size: 12px;
                    color: #ccc;
                    cursor: pointer;
                    user-select: all;
                  "
                  title="Click to copy"
                  >-</span
                >
              </div>
              <div class="row" style="gap: 4px; margin-top: 4px">
                <input
                  id="seedInput"
                  type="text"
                  placeholder="Enter seed"
                  style="flex: 1; font-size: 12px"
                  title="Enter a seed value or extended seed (format: seed-families-outline-smooth-blend-contrast-consensus-spatial-tolerance) to reproduce specific results with settings. Leave empty for random clustering."
                />
              </div>
            </div>
          </div>
        </fieldset>
      </div>
      <!-- RIGHT -->
      <div class="card">
        <!-- Controls moved from header -->
        <div class="controls-section">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 8px;
            "
          >
            <h1 style="margin: 0">PokÃ©mon Shiny Recolor Tool</h1>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: flex-end;
            "
          >
            <div class="controls">
              <label class="btn"
                ><input
                  id="pickRoot"
                  type="file"
                  webkitdirectory
                  multiple
                  accept="image/*"
                  title="Select the root folder containing PokÃ©mon texture files to work with."
                />Pick Root Folder</label
              >
              <label class="btn" id="loadShinyLabel"
                ><input
                  id="loadShiny"
                  type="file"
                  accept="image/png"
                  title="Load an existing shiny sprite for editing."
                  style="display: none"
                  disabled
                />Load Shiny</label
              >
              <button
                id="saveBtn"
                class="btn gray"
                title="Save the current shiny sprite as a PNG file."
              >
                Save PNG
              </button>
            </div>
            <div class="controls">
              <button
                id="zoomToggle"
                class="btn gray"
                title="Toggle zoom mode to see magnified view when hovering over sprites."
              >
                Zoom Mode
              </button>
              <button
                id="hotkeyBtn"
                class="btn gray"
                title="Open the hotkey configuration menu to customize keyboard shortcuts."
              >
                Hotkeys
              </button>
              <button
                id="tutorialBtn"
                class="btn gray"
                title="Open the tutorial to learn how to use the tool effectively."
              >
                Tutorial
              </button>
            </div>
          </div>
        </div>

        <div class="preview">
          <div class="canvasWrap">
            <fieldset>
              <legend>Original</legend>
              <canvas id="c0"></canvas>
              <div class="row">
                <select
                  id="sourceSel"
                  title="Choose which texture or sprite to display in the Original canvas."
                >
                  <option value="">
                    (choose source image: textures & sprites)
                  </option>
                </select>
              </div>
            </fieldset>
            <div class="loadingIndicator" id="loadingOriginal">
              <div class="loadingSpinner"></div>
              <span>Loading...</span>
            </div>
            <canvas id="dbg0" class="debugOverlay"></canvas>
            <div
              id="zoomOverlay0"
              class="zoomOverlay"
              style="
                position: fixed;
                width: 100px;
                height: 100px;
                border-radius: 50%;
                border: 2px solid #111;
                box-shadow: 0 0 0 2px #0003 inset;
                background: #000;
                display: none;
                pointer-events: none;
                overflow: hidden;
                z-index: 100;
              "
            >
              <canvas
                id="zoomCanvas0"
                width="100"
                height="100"
                style="width: 100%; height: 100%; image-rendering: pixelated"
              ></canvas>
            </div>
          </div>
          <div class="canvasWrap">
            <fieldset>
              <legend>Shiny</legend>
              <!-- Normal single canvas mode -->
              <div id="singleCanvasMode">
                <canvas id="c1"></canvas>
              </div>
              <!-- Multi-seed preview mode with 4 canvas in 2x2 grid -->
              <div id="multiSeedMode" style="display: none">
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 8px;
                  "
                >
                  <div style="text-align: center">
                    <canvas
                      id="c1_preview1"
                      style="cursor: pointer"
                      title="Click to select this variant"
                    ></canvas>
                    <div class="seed-display">
                      Seed: <span id="seed1">-</span>
                    </div>
                  </div>
                  <div style="text-align: center">
                    <canvas
                      id="c1_preview2"
                      style="cursor: pointer"
                      title="Click to select this variant"
                    ></canvas>
                    <div class="seed-display">
                      Seed: <span id="seed2">-</span>
                    </div>
                  </div>
                  <div style="text-align: center">
                    <canvas
                      id="c1_preview3"
                      style="cursor: pointer"
                      title="Click to select this variant"
                    ></canvas>
                    <div class="seed-display">
                      Seed: <span id="seed3">-</span>
                    </div>
                  </div>
                  <div style="text-align: center">
                    <canvas
                      id="c1_preview4"
                      style="cursor: pointer"
                      title="Click to select this variant"
                    ></canvas>
                    <div class="seed-display">
                      Seed: <span id="seed4">-</span>
                    </div>
                  </div>
                </div>
              </div>
            </fieldset>
            <div class="loadingIndicator" id="loadingShiny">
              <div class="loadingSpinner"></div>
              <span>Loading...</span>
            </div>
            <canvas id="cGuide" style="display: none"></canvas>
            <canvas id="dbg1" class="debugOverlay"></canvas>
            <div
              id="zoomOverlay1"
              class="zoomOverlay"
              style="
                position: fixed;
                width: 100px;
                height: 100px;
                border-radius: 50%;
                border: 2px solid #111;
                box-shadow: 0 0 0 2px #0003 inset;
                background: #000;
                display: none;
                pointer-events: none;
                overflow: hidden;
                z-index: 100;
              "
            >
              <canvas
                id="zoomCanvas1"
                width="100"
                height="100"
                style="width: 100%; height: 100%; image-rendering: pixelated"
              ></canvas>
            </div>
          </div>
        </div>

        <div id="status">
          Welcome! Select a root folder containing PokÃ©mon textures to get
          started
        </div>
      </div>
      <div class="card">
        <fieldset>
          <legend>Color Families</legend>
          <div
            style="
              display: flex;
              align-items: center;
              gap: 8px;
              margin-bottom: 8px;
            "
          >
            <h3 id="sheetTitle" style="margin: 0; font-size: 14px">Family</h3>
            <label
              for="sheetColor"
              id="pickedSwatch"
              style="
                display: inline-block;
                width: 24px;
                height: 24px;
                border: 2px solid #444;
                border-radius: 6px;
                background: #000;
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
              "
              title="Click to change the color of the selected family."
            >
              <input
                id="sheetColor"
                type="color"
                value="#000000"
                style="
                  position: absolute;
                  opacity: 0;
                  width: 100%;
                  height: 100%;
                  cursor: pointer;
                "
                title="Manually set the color for the selected family."
              />
            </label>
          </div>

          <!-- Checkbox controls with revert button in compact layout -->
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr auto;
              gap: 4px;
              margin-bottom: 8px;
              font-size: 11px;
              align-items: center;
            "
          >
            <label class="toggle" style="gap: 4px"
              ><input
                id="sheetLink"
                type="checkbox"
                checked
                title="Use automatic color for this family area. When enabled, individual pixel edits are cleared and the suggested color is used."
              /><span>Clear pixels</span></label
            >
            <label class="toggle" style="gap: 4px"
              ><input
                id="sheetKeep"
                type="checkbox"
                title="Keep the original colors for this family area unchanged."
              /><span>Keep original</span></label
            >
            <button
              id="sheetRevert"
              class="btn gray small"
              title="Revert this family area to its original state or suggested color, and reset brightness to 0."
            >
              â†º Revert
            </button>
          </div>

          <!-- Darkness slider -->
          <div class="kv" style="margin-bottom: 8px">
            <label style="font-size: 12px">Darkness (Î”L)</label>
            <input
              id="sheetDark"
              type="range"
              min="-40"
              max="40"
              value="0"
              title="Adjust the lightness/darkness of the selected family area. Negative values make it darker, positive values make it lighter."
            /><span id="sheetDarkVal" style="font-size: 12px">0</span>
          </div>

          <!-- Action buttons in compact grid -->
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 4px;
              font-size: 11px;
            "
          >
            <button
              id="pickFromPreview"
              class="btn gray small"
              style="display: none"
              title="Click this, then click on the shiny preview to pick a color from it."
            >
              ðŸŽ¯ Preview
            </button>
            <button
              id="pickFromTexture"
              class="btn gray small"
              style="display: none"
              title="Pick a color from a texture overlay. Select a texture first in the dropdown."
            >
              ðŸŽ¯ Texture
            </button>
            <div style="display: flex; align-items: center; gap: 4px">
              <button
                id="colorPickAndApply"
                class="btn gray small"
                title="Pick color from Original, then click on Shiny to apply"
              >
                Apply Multiple
              </button>
              <label
                class="toggle"
                id="pixelLevelModeLabel"
                style="
                  font-size: 11px;
                  display: none;
                  gap: 2px;
                  white-space: nowrap;
                "
                title="Enable individual pixel-level editing instead of family-based editing."
              >
                <input id="pixelLevelMode" type="checkbox" />
                <span>Individual pixels</span>
              </label>
            </div>
            <select
              id="texChooser"
              style="display: none; padding: 4px 6px; font-size: 11px"
              class="btn gray"
              title="Choose which shiny texture to use for color picking."
            >
              <option value="">(choose shiny texture)</option>
            </select>
          </div>

          <!-- Hidden elements -->
          <span
            id="pickedColorForApply"
            style="
              display: none;
              align-items: center;
              gap: 4px;
              padding: 4px 8px;
              background: var(--bg2);
              border: 1px solid var(--bd);
              border-radius: 4px;
              font-size: 12px;
              margin-top: 4px;
            "
          >
            <span
              id="pickedColorSwatch"
              style="
                display: inline-block;
                width: 16px;
                height: 16px;
                border: 1px solid #444;
                border-radius: 2px;
                background: #000;
              "
            ></span>
            <span>Picked</span>
          </span>
        </fieldset>

        <fieldset>
          <legend>Home Texture Preview</legend>

          <!-- Shiny texture -->
          <div class="canvasWrap" style="margin-bottom: 8px">
            <legend
              style="font-size: 11px; color: var(--mut); margin-bottom: 2px"
            >
              Shiny
            </legend>
            <canvas
              id="homeTextureCanvas"
              style="
                background: #fff;
                width: 100%;
                max-width: auto;
                height: auto;
                border: 1px solid var(--bd);
                border-radius: 6px;
                image-rendering: pixelated;
                display: none;
              "
            ></canvas>
            <div
              id="homeTextureStatus"
              style="
                color: var(--mut);
                font-size: 11px;
                text-align: center;
                padding: 6px;
              "
            >
              No shiny home texture
            </div>
          </div>

          <!-- Normal texture -->
          <div class="canvasWrap">
            <legend
              style="font-size: 11px; color: var(--mut); margin-bottom: 2px"
            >
              Normal
            </legend>
            <canvas
              id="homeTextureCanvasNormal"
              style="
                background: #fff;
                width: 100%;
                max-width: auto;
                height: auto;
                border: 1px solid var(--bd);
                border-radius: 6px;
                image-rendering: pixelated;
                display: none;
              "
            ></canvas>
            <div
              id="homeTextureStatusNormal"
              style="
                color: var(--mut);
                font-size: 11px;
                text-align: center;
                padding: 6px;
              "
            >
              No normal home texture
            </div>
          </div>
        </fieldset>
      </div>
    </div>

    <!-- Hotkeys Modal -->
    <div id="hotkeyModal" class="modal-overlay">
      <div class="sheet-content">
        <div class="row">
          <h3>Hotkey Settings</h3>
          <div style="display: flex; gap: 8px">
            <button
              id="saveHotkeys"
              class="btn"
              title="Save the current hotkey configuration."
            >
              Save Hotkeys
            </button>
            <button
              id="closeHotkeyModal"
              class="btn gray"
              title="Close the hotkey configuration menu."
            >
              Close
            </button>
          </div>
        </div>
        <div class="section">
          <div class="kv">
            <label>Open Hotkeys</label
            ><input
              id="hkOpen"
              type="text"
              placeholder="?"
              title="Hotkey to open this hotkey configuration menu."
            />
            <label>Tutorial</label
            ><input
              id="hkTutorial"
              type="text"
              placeholder="h"
              title="Hotkey to open the tutorial guide."
            />
            <label>Load Selected</label
            ><input
              id="hkLoad"
              type="text"
              placeholder="l"
              title="Hotkey to automatically load the selected texture files."
            />
            <label>Save PNG</label
            ><input
              id="hkSave"
              type="text"
              placeholder="s"
              title="Hotkey to save the current shiny sprite as PNG."
            />
            <label>Recluster</label
            ><input
              id="hkRecluster"
              type="text"
              placeholder="r"
              title="Hotkey to recalculate color families."
            />
            <label>Toggle Debug</label
            ><input
              id="hkDebug"
              type="text"
              placeholder="d"
              title="Hotkey to toggle the protected pixel overlay."
            />
            <label>Toggle Family Outline</label
            ><input
              id="hkOutline"
              type="text"
              placeholder="o"
              title="Hotkey to toggle the selected family outline."
            />
            <label>Pick from Preview</label
            ><input
              id="hkPickPrev"
              type="text"
              placeholder="p"
              title="Hotkey to enable color picking from the shiny preview."
            />
            <label>Pick from Texture</label
            ><input
              id="hkPickTex"
              type="text"
              placeholder="t"
              title="Hotkey to open texture color picker."
            />
            <label>Apply Multiple</label
            ><input
              id="hkPickApply"
              type="text"
              placeholder="a"
              title="Hotkey to enable Pick & Apply mode for applying colors to multiple families."
            />
            <label>Prev Family</label
            ><input
              id="hkPrevReg"
              type="text"
              placeholder="["
              title="Hotkey to select the previous color family."
            />
            <label>Next Family</label
            ><input
              id="hkNextReg"
              type="text"
              placeholder="]"
              title="Hotkey to select the next color family."
            />
            <label>Keep Original (family)</label
            ><input
              id="hkKeep"
              type="text"
              placeholder="k"
              title="Hotkey to toggle 'Keep Original' for the selected region."
            />
            <label>Previous PokÃ©mon</label
            ><input
              id="hkPrevPokemon"
              type="text"
              placeholder=","
              title="Hotkey to navigate to the previous PokÃ©mon in the folder."
            />
            <label>Next PokÃ©mon</label
            ><input
              id="hkNextPokemon"
              type="text"
              placeholder="."
              title="Hotkey to navigate to the next PokÃ©mon in the folder."
            />
            <label>Toggle Zoom Mode</label
            ><input
              id="hkZoom"
              type="text"
              placeholder="z"
              title="Hotkey to toggle zoom mode for magnified sprite viewing."
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Tutorial Modal -->
    <!-- Tutorial Modal -->
    <div id="tutorialModal" class="modal-overlay">
      <div class="sheet-content" id="tutorialContent">
        <!-- Tutorial content will be loaded here -->
      </div>
    </div>

    <!-- Texture Eyedropper -->
    <!-- Texture Eyedropper -->
    <div
      id="pickerOverlay"
      style="
        display: none;
        position: fixed;
        inset: 0;
        background: #0006;
        backdrop-filter: blur(1px);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      "
    >
      <div style="position: relative; max-width: 96vw; max-height: 70vh">
        <canvas
          id="texCanvas"
          style="
            max-width: 96vw;
            max-height: 70vh;
            background: #fff;
            border: 1px solid #94a3b8;
            touch-action: none;
          "
          title="Click or drag on the texture to pick colors. The magnifying glass shows a zoomed view of the area under your cursor."
        ></canvas>
        <div
          id="loupe"
          style="
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 2px solid #111;
            box-shadow: 0 0 0 2px #0003 inset;
            background: #000;
            display: none;
            pointer-events: none;
            overflow: hidden;
          "
        >
          <canvas
            id="loupeCanvas"
            width="120"
            height="120"
            style="width: 100%; height: 100%; image-rendering: pixelated"
          ></canvas>
        </div>
      </div>
      <div
        style="
          margin-top: 8px;
          display: flex;
          gap: 8px;
          align-items: center;
          flex-wrap: wrap;
          justify-content: center;
        "
      >
        <button
          id="pickerDone"
          class="btn gray"
          title="Confirm the color selection and close the texture picker."
        >
          Done
        </button>
        <button
          id="pickerCancel"
          class="btn gray"
          title="Cancel color picking and close the texture picker without making changes."
        >
          Cancel
        </button>
        <span class="mut" style="color: #e5e7eb"
          >Tap/drag to sample. Sets this regionâ€™s shiny base (if unlinked & not
          kept).</span
        >
      </div>
    </div>

    <script type="module">
      import "./scripts.js";
    </script>
  </body>
</html>
