<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pokémon Recolor Tool</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <fieldset>
          <legend>Pokémon</legend>
          <div class="kv kv-onecol">
            <div class="row" style="gap: 4px">
              <select
                id="folderSel"
                style="flex: 1"
                title="Select a Pokémon folder to work with"
              >
                <option value="">(pick root)</option>
              </select>
              <button
                id="prevPokemon"
                class="btn gray"
                style="padding: 6px 8px; font-size: 14px"
                title="Previous Pokémon"
              >
                ‹
              </button>
              <button
                id="nextPokemon"
                class="btn gray"
                style="padding: 6px 8px; font-size: 14px"
                title="Next Pokémon"
              >
                ›
              </button>
            </div>
            <div id="texList" class="list">
              <small
                >Select normal <code>*_col.png</code>. Matching
                <code>*_col_rare</code> is used internally.</small
              >
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Settings</legend>
          <div class="kv">
            <label>Family Count</label
            ><input
              id="k"
              type="range"
              min="5"
              max="48"
              value="32"
              title="Number of color families to group similar colors together. Higher values create more distinct color regions."
            /><span id="kVal">32</span>
            <label class="mut" style="display: none">Spatial weight</label
            ><input
              id="spw"
              style="display: none"
              type="range"
              min="0"
              max="200"
              value="60"
            /><span id="spwVal" style="display: none">0.60</span>
            <label>Protect Outline</label
            ><input
              id="ink"
              type="range"
              min="0"
              max="50"
              value="8"
              title="Protects dark pixels (like outlines) from being recolored. Higher values protect more pixels."
            /><span id="inkVal">8</span> <label>Smoothing</label
            ><input
              id="smoothPx"
              type="range"
              min="0"
              max="5"
              value="1"
              title="Applies smoothing to reduce noise and artifacts. Higher values create smoother transitions."
            /><span id="smoothPxVal">1</span> <label>Blending</label
            ><input
              id="smoothAmt"
              type="range"
              min="0"
              max="100"
              value="45"
              title="Controls how much smoothing is applied. Higher values create more blended colors."
            /><span id="smoothAmtVal">45%</span> <label>Contrast</label
            ><input
              id="contrast"
              type="range"
              min="50"
              max="170"
              value="110"
              title="Adjusts the contrast of the final shiny sprite. Higher values increase contrast."
            /><span id="contrastVal">110%</span> <label>Color Consensus</label
            ><input
              id="colorConsensus"
              type="range"
              min="1"
              max="10"
              value="1"
              title="Number of texture candidates to consider for color suggestions. Higher values blend more textures for smoother results."
            /><span id="colorConsensusVal">1</span>
          </div>
          <hr />
          <div class="row">
            <label class="toggle"
              ><input
                id="showDebug"
                type="checkbox"
                title="Shows an overlay highlighting protected pixels that won't be recolored."
              />
              Show protected overlay</label
            >
            <label class="toggle"
              ><input
                id="showRegionOutline"
                type="checkbox"
                title="Shows an outline around the currently selected color region."
              />
              Show selected region outline</label
            >
            <button
              id="recluster"
              class="btn gray"
              title="Recalculates color families and regions with current settings. Use after changing Family Count or other clustering parameters."
            >
              Recluster
            </button>
            <button
              id="restoreDefaults"
              class="btn gray"
              title="Restores all settings to their default values."
            >
              Restore Defaults
            </button>
            <div class="row" style="gap: 4px; margin-top: 8px">
              <label style="font-size: 12px; color: #888">Extended Seed:</label>
              <span
                id="currentSeed"
                style="
                  font-family: monospace;
                  font-size: 12px;
                  color: #ccc;
                  cursor: pointer;
                  user-select: all;
                "
                title="Click to copy"
                >-</span
              >
            </div>
            <div class="row" style="gap: 4px; margin-top: 4px">
              <input
                id="seedInput"
                type="text"
                placeholder="Enter seed or extended seed"
                style="flex: 1; font-size: 12px"
                title="Enter a seed value or extended seed (format: seed-families-outline-smooth-blend-contrast-consensus) to reproduce specific results with settings. Leave empty for random clustering."
              />
            </div>
            <div style="font-size: 10px; color: #666; margin-top: 2px">
              Example: 1234567890-32-8-1-45-110-1
            </div>
          </div>
        </fieldset>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <!-- Controls moved from header -->
        <div class="controls-section">
          <h1>Pokémon Recolor Tool</h1>
          <div class="controls">
            <label class="btn"
              ><input
                id="pickRoot"
                type="file"
                webkitdirectory
                multiple
                accept="image/*"
                title="Select the root folder containing Pokémon texture files to work with."
              />Pick Root Folder</label
            >
            <label class="btn" id="loadShinyLabel"
              ><input
                id="loadShiny"
                type="file"
                accept="image/png"
                title="Load an existing shiny sprite for editing."
                style="display: none"
                disabled
              />Load Shiny</label
            >
            <button
              id="saveBtn"
              class="btn gray"
              title="Save the current shiny sprite as a PNG file."
            >
              Save PNG
            </button>
            <button
              id="hotkeyBtn"
              class="btn gray"
              title="Open the hotkey configuration menu to customize keyboard shortcuts."
            >
              Hotkeys
            </button>
            <button
              id="zoomToggle"
              class="btn gray"
              title="Toggle zoom mode to see magnified view when hovering over sprites."
            >
              Zoom Mode
            </button>
          </div>
        </div>

        <div class="preview">
          <div class="canvasWrap">
            <fieldset>
              <legend>Original</legend>
              <canvas id="c0"></canvas>
              <div class="row">
                <select
                  id="sourceSel"
                  class="btn gray"
                  title="Choose which texture or sprite to display in the Original canvas."
                >
                  <option value="">
                    (choose source image: textures & sprites)
                  </option>
                </select>
              </div>
            </fieldset>
            <canvas id="dbg0" class="debugOverlay"></canvas>
            <div
              id="zoomOverlay0"
              class="zoomOverlay"
              style="
                position: absolute;
                width: 100px;
                height: 100px;
                border-radius: 50%;
                border: 2px solid #111;
                box-shadow: 0 0 0 2px #0003 inset;
                background: #000;
                display: none;
                pointer-events: none;
                overflow: hidden;
                z-index: 100;
              "
            >
              <canvas
                id="zoomCanvas0"
                width="100"
                height="100"
                style="width: 100%; height: 100%; image-rendering: pixelated"
              ></canvas>
            </div>
          </div>
          <div class="canvasWrap">
            <fieldset>
              <legend>Shiny</legend>
              <canvas id="c1"></canvas>
            </fieldset>
            <canvas id="cGuide" style="display: none"></canvas>
            <canvas id="dbg1" class="debugOverlay"></canvas>
            <div
              id="zoomOverlay1"
              class="zoomOverlay"
              style="
                position: absolute;
                width: 100px;
                height: 100px;
                border-radius: 50%;
                border: 2px solid #111;
                box-shadow: 0 0 0 2px #0003 inset;
                background: #000;
                display: none;
                pointer-events: none;
                overflow: hidden;
                z-index: 100;
              "
            >
              <canvas
                id="zoomCanvas1"
                width="100"
                height="100"
                style="width: 100%; height: 100%; image-rendering: pixelated"
              ></canvas>
            </div>
          </div>
        </div>

        <div id="status">Idle</div>
      </div>
      <div class="card">
        <fieldset>
          <legend>Region</legend>
          <div class="row" style="margin-top: 0">
            <h3 id="sheetTitle" style="margin-top: 0">Region</h3>
            <span
              id="pickedSwatch"
              style="
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 1px solid #444;
                border-radius: 4px;
                background: #000;
                margin-left: 8px;
              "
              title="Shows the current color of the selected region."
            ></span>
          </div>
          <div class="section">
            <div class="row" style="gap: 8px; flex-wrap: wrap">
              <span class="pill"
                ><input
                  id="sheetColor"
                  type="color"
                  value="#000000"
                  title="Manually set the color for the selected region."
                /><span>Manual color</span></span
              >
              <span class="pill"
                ><input
                  id="sheetLink"
                  type="checkbox"
                  checked
                  title="Link this region to its color family. When linked, individual pixel edits are cleared and the family color is used."
                /><span>Link to family (clears individual pixels)</span></span
              >
              <span class="pill"
                ><input
                  id="sheetKeep"
                  type="checkbox"
                  title="Keep the original colors for this region unchanged."
                /><span>Keep original</span></span
              >
              <button
                id="sheetRevert"
                class="btn gray"
                title="Revert this region to its original state or family color."
              >
                ↺ Revert
              </button>
            </div>
          </div>
          <div class="section">
            <div class="kv">
              <label>Darkness (ΔL)</label>
              <input
                id="sheetDark"
                type="range"
                min="-40"
                max="40"
                value="0"
                title="Adjust the lightness/darkness of the selected region. Negative values make it darker, positive values make it lighter."
              /><span id="sheetDarkVal">0</span>
            </div>
          </div>
          <div class="section">
            <div class="row" style="gap: 8px; flex-wrap: wrap">
              <button
                id="pickFromPreview"
                class="btn gray"
                style="display: none"
                title="Click this, then click on the shiny preview to pick a color from it."
              >
                🎯 Pick from preview
              </button>
              <button
                id="pickFromTexture"
                class="btn gray"
                style="display: none"
                title="Pick a color from a texture overlay. Select a texture first in the dropdown."
              >
                🎯 Pick from texture
              </button>
              <button
                id="colorPickAndApply"
                class="btn gray"
                title="Pick color from Original, then click on Shiny to apply"
              >
                Apply Multiple
              </button>
              <label
                class="toggle"
                style="font-size: 12px; margin-left: 4px; display: none"
                title="Enable individual pixel-level editing instead of region-based editing."
              >
                <input id="pixelLevelMode" type="checkbox" />
                Individual pixels
              </label>
              <select
                id="texChooser"
                style="display: none; padding: 8px 10px"
                class="btn gray"
                title="Choose which shiny texture to use for color picking."
              >
                <option value="">(choose shiny texture)</option>
              </select>
              <span
                id="pickedColorForApply"
                style="
                  display: none;
                  align-items: center;
                  gap: 4px;
                  padding: 4px 8px;
                  background: var(--bg2);
                  border: 1px solid var(--bd);
                  border-radius: 4px;
                  font-size: 12px;
                "
              >
                <span
                  id="pickedColorSwatch"
                  style="
                    display: inline-block;
                    width: 16px;
                    height: 16px;
                    border: 1px solid #444;
                    border-radius: 2px;
                    background: #000;
                  "
                ></span>
                <span>Picked</span>
              </span>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Home Texture Preview</legend>
          <div>
            <div class="canvasWrap" style="margin-bottom: 16px">
              <legend
                style="font-size: 12px; color: var(--mut); margin-bottom: 4px"
              >
                Shiny
              </legend>
              <canvas
                id="homeTextureCanvas"
                style="
                  background: #fff;
                  width: 100%;
                  max-width: auto;
                  height: auto;
                  border: 1px solid var(--bd);
                  border-radius: 10px;
                  image-rendering: pixelated;
                  display: none;
                "
              ></canvas>
              <div
                id="homeTextureStatus"
                style="
                  color: var(--mut);
                  font-size: 12px;
                  text-align: center;
                  padding: 8px;
                "
              >
                No shiny home texture
              </div>
            </div>
            <div class="canvasWrap">
              <legend
                style="font-size: 12px; color: var(--mut); margin-bottom: 4px"
              >
                Normal
              </legend>
              <canvas
                id="homeTextureCanvasNormal"
                style="
                  background: #fff;
                  width: 100%;
                  max-width: auto;
                  height: auto;
                  border: 1px solid var(--bd);
                  border-radius: 10px;
                  image-rendering: pixelated;
                  display: none;
                "
              ></canvas>
              <div
                id="homeTextureStatusNormal"
                style="
                  color: var(--mut);
                  font-size: 12px;
                  text-align: center;
                  padding: 8px;
                "
              >
                No normal home texture
              </div>
            </div>
          </div>
        </fieldset>
      </div>
    </div>

    <!-- Hotkeys Modal -->
    <div id="hotkeyModal" class="modal-overlay">
      <div class="sheet-content">
        <div class="row">
          <h3>Hotkey Settings</h3>
          <button
            id="closeHotkeyModal"
            class="btn gray"
            title="Close the hotkey configuration menu."
          >
            Close
          </button>
        </div>
        <div class="section">
          <div class="kv">
            <label>Open Hotkeys</label
            ><input
              id="hkOpen"
              type="text"
              placeholder="?"
              title="Hotkey to open this hotkey configuration menu."
            />
            <label>Load Selected</label
            ><input
              id="hkLoad"
              type="text"
              placeholder="l"
              title="Hotkey to automatically load the selected texture files."
            />
            <label>Save PNG</label
            ><input
              id="hkSave"
              type="text"
              placeholder="s"
              title="Hotkey to save the current shiny sprite as PNG."
            />
            <label>Recluster</label
            ><input
              id="hkRecluster"
              type="text"
              placeholder="r"
              title="Hotkey to recalculate color families and regions."
            />
            <label>Toggle Debug</label
            ><input
              id="hkDebug"
              type="text"
              placeholder="d"
              title="Hotkey to toggle the protected pixel overlay."
            />
            <label>Toggle Region Outline</label
            ><input
              id="hkOutline"
              type="text"
              placeholder="o"
              title="Hotkey to toggle the selected region outline."
            />
            <label>Pick from Preview</label
            ><input
              id="hkPickPrev"
              type="text"
              placeholder="p"
              title="Hotkey to enable color picking from the shiny preview."
            />
            <label>Pick from Texture</label
            ><input
              id="hkPickTex"
              type="text"
              placeholder="t"
              title="Hotkey to open texture color picker."
            />
            <label>Apply Multiple</label
            ><input
              id="hkPickApply"
              type="text"
              placeholder="a"
              title="Hotkey to enable Pick & Apply mode for applying colors to multiple regions."
            />
            <label>Prev Region</label
            ><input
              id="hkPrevReg"
              type="text"
              placeholder="["
              title="Hotkey to select the previous color region."
            />
            <label>Next Region</label
            ><input
              id="hkNextReg"
              type="text"
              placeholder="]"
              title="Hotkey to select the next color region."
            />
            <label>Keep Original (region)</label
            ><input
              id="hkKeep"
              type="text"
              placeholder="k"
              title="Hotkey to toggle 'Keep Original' for the selected region."
            />
            <label>Previous Pokémon</label
            ><input
              id="hkPrevPokemon"
              type="text"
              placeholder=","
              title="Hotkey to navigate to the previous Pokémon in the folder."
            />
            <label>Next Pokémon</label
            ><input
              id="hkNextPokemon"
              type="text"
              placeholder="."
              title="Hotkey to navigate to the next Pokémon in the folder."
            />
            <label>Toggle Zoom Mode</label
            ><input
              id="hkZoom"
              type="text"
              placeholder="z"
              title="Hotkey to toggle zoom mode for magnified sprite viewing."
            />
          </div>
        </div>
        <div class="section">
          <button
            id="saveHotkeys"
            class="btn"
            title="Save the current hotkey configuration."
          >
            Save Hotkeys
          </button>
        </div>
      </div>
    </div>

    <!-- Texture Eyedropper -->
    <div
      id="pickerOverlay"
      style="
        display: none;
        position: fixed;
        inset: 0;
        background: #0006;
        backdrop-filter: blur(1px);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      "
    >
      <div style="position: relative; max-width: 96vw; max-height: 70vh">
        <canvas
          id="texCanvas"
          style="
            max-width: 96vw;
            max-height: 70vh;
            background: #fff;
            border: 1px solid #94a3b8;
            touch-action: none;
          "
          title="Click or drag on the texture to pick colors. The magnifying glass shows a zoomed view of the area under your cursor."
        ></canvas>
        <div
          id="loupe"
          style="
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 2px solid #111;
            box-shadow: 0 0 0 2px #0003 inset;
            background: #000;
            display: none;
            pointer-events: none;
            overflow: hidden;
          "
        >
          <canvas
            id="loupeCanvas"
            width="120"
            height="120"
            style="width: 100%; height: 100%; image-rendering: pixelated"
          ></canvas>
        </div>
      </div>
      <div
        style="
          margin-top: 8px;
          display: flex;
          gap: 8px;
          align-items: center;
          flex-wrap: wrap;
          justify-content: center;
        "
      >
        <button
          id="pickerDone"
          class="btn gray"
          title="Confirm the color selection and close the texture picker."
        >
          Done
        </button>
        <button
          id="pickerCancel"
          class="btn gray"
          title="Cancel color picking and close the texture picker without making changes."
        >
          Cancel
        </button>
        <span class="mut" style="color: #e5e7eb"
          >Tap/drag to sample. Sets this region’s shiny base (if unlinked & not
          kept).</span
        >
      </div>
    </div>

    <script type="module">
      import "./scripts.js";
    </script>
  </body>
</html>
